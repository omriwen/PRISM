# Golden Reference Outputs

This directory contains golden reference outputs generated by the regression test suite (`tests/regression/test_instrument_outputs.py`).

## Purpose

These golden outputs serve as numerical baselines to ensure that refactoring efforts (particularly the Four-F System consolidation in `feature/four-f-system-consolidation`) do not change the numerical behavior of the instruments.

## Contents

Golden outputs are saved as `.npz` (NumPy compressed) files with the following naming convention:

### Microscope Golden Outputs
- `microscope_psf_brightfield.npz` - Brightfield PSF
- `microscope_psf_darkfield.npz` - Darkfield PSF
- `microscope_psf_phase.npz` - Phase contrast PSF
- `microscope_forward_brightfield.npz` - Brightfield forward model output
- `microscope_forward_darkfield.npz` - Darkfield forward model output
- `microscope_forward_phase.npz` - Phase contrast forward model output
- `microscope_spids_aperture.npz` - SPIDS sub-aperture measurement

### Telescope Golden Outputs
- `telescope_psf_circular.npz` - Circular aperture PSF
- `telescope_psf_hexagonal.npz` - Hexagonal aperture PSF
- `telescope_forward_circular.npz` - Circular aperture forward model
- `telescope_forward_hexagonal.npz` - Hexagonal aperture forward model
- `telescope_sub_aperture.npz` - Off-center sub-aperture (SPIDS mode)

### Camera Golden Outputs
- `camera_psf_far_field.npz` - Far-field PSF
- `camera_psf_near_field.npz` - Near-field PSF
- `camera_psf_defocused.npz` - Defocused PSF
- `camera_forward_far_field.npz` - Far-field forward model
- `camera_forward_near_field.npz` - Near-field forward model

## Generation

To generate golden outputs:

```bash
# Activate virtual environment
source .venv/bin/activate

# Run golden output generation tests (non-regression tests)
uv run pytest tests/regression/test_instrument_outputs.py -v -k "not regression"
```

This will create all `.npz` files in this directory.

## Regression Testing

To run regression tests (compare current outputs against golden):

```bash
# Run regression tests
uv run pytest tests/regression/test_instrument_outputs.py -v -m regression
```

Regression tests will be skipped if golden outputs have not been generated.

## Numerical Tolerance

Golden output comparisons use:
- Absolute tolerance: `atol = 1e-6`
- Relative tolerance: `rtol = 1e-5`

These tolerances are defined in `tests/regression/test_instrument_outputs.py`.

## File Format

Each `.npz` file contains:
- `psf` or `output`: The main output array
- `input`: Input field used (for forward model tests)
- Additional metadata (e.g., `aperture_center`, `defocus`, etc.)

## Maintenance

Golden outputs should be regenerated when:
1. Intentional numerical changes are made to instrument physics
2. The baseline implementation changes in a documented way
3. Test parameters are updated

**Never** regenerate golden outputs to "fix" a failing regression test without understanding why the output changed.

## Git Tracking

Golden outputs (`.npz` files) are **not tracked** in git (see `.gitignore`). They are generated locally during testing. This prevents large binary files from bloating the repository.

Each developer must generate their own golden outputs before running regression tests.
